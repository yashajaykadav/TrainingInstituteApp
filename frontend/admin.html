<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <style>
    body { background: #f5f8fb; font-family: 'Segoe UI', sans-serif; display: flex; min-height: 100vh; overflow-x: hidden; }
    
    /* Sidebar */
    .sidebar { width: 250px; background: linear-gradient(180deg, #1565C0, #1E88E5); color: white; position: fixed; top: 0; left: 0; height: 100%; z-index: 100; transition: width 0.3s; padding-top: 1rem; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 70px; }
    .sidebar .logo { font-size: 1.4rem; font-weight: bold; text-align: center; margin-bottom: 2rem; letter-spacing: 1px; }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar ul li { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: background 0.2s; }
    .sidebar ul li:hover, .sidebar ul li.active { background: rgba(255,255,255,0.2); }
    .sidebar .material-icons-outlined { font-size: 24px; }
    .sidebar.collapsed .text { display: none; }
    
    /* Layout */
    .main { margin-left: 250px; padding: 80px 30px; width: 100%; transition: margin-left 0.3s; }
    .sidebar.collapsed ~ .main { margin-left: 70px; }
    
    /* Topbar */
    .topbar { background: white; position: fixed; left: 250px; top: 0; right: 0; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); z-index: 99; transition: left 0.3s; }
    .sidebar.collapsed + .main .topbar { left: 70px; }

    /* Cards */
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .stat-card h5 { margin: 10px 0 0; font-weight: bold; font-size: 1.5rem; }
    .stat-card .material-icons-outlined { font-size: 40px; color: #1565C0; }
    
    .scroll-box { max-height: 400px; overflow-y: auto; }
    .hidden { display: none; }
    
    /* Schedule Grid */
    .schedule-grid { display: grid; grid-template-columns: 100px repeat(5, 1fr); gap: 2px; background: #dee2e6; border-radius: 8px; overflow: hidden; }
    .schedule-cell { background: white; padding: 8px; min-height: 80px; font-size: 0.8rem; }
    .schedule-header { background: #1565C0; color: white; font-weight: bold; text-align: center; padding: 10px; }
    .time-slot { background: #e3f2fd; font-weight: 500; display: flex; align-items: center; justify-content: center; text-align: center; }
    .slot-empty { background: #f8f9fa; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; justify-content: center; }
    .slot-empty:hover { background: #e3f2fd; }
    .slot-booked { background: #d4edda; cursor: pointer; }
    
    /* Module Badge */
    .module-badge { background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin: 2px; display: inline-block; }
    
    /* Modal improvements */
    .modal-header.bg-primary { background: linear-gradient(135deg, #1565C0, #1E88E5) !important; }
  </style>
</head>

<body>

  <div class="sidebar" id="sidebar">
    <div class="logo"><span class="material-icons-outlined">admin_panel_settings</span> <span class="text">Admin</span></div>
    <ul>
      <li class="active" onclick="showSection('dashboard')"><span class="material-icons-outlined">dashboard</span><span class="text">Dashboard</span></li>
      <li onclick="showSection('users')"><span class="material-icons-outlined">people</span><span class="text">Users</span></li>
      <li onclick="showSection('courses')"><span class="material-icons-outlined">library_books</span><span class="text">Courses</span></li>
      <li onclick="showSection('enrollments')"><span class="material-icons-outlined">school</span><span class="text">Enrollments</span></li>
      <li onclick="showSection('schedules')"><span class="material-icons-outlined">calendar_month</span><span class="text">Schedules</span></li>
      <li onclick="logout()"><span class="material-icons-outlined">logout</span><span class="text">Logout</span></li>
    </ul>
  </div>

  <div class="main">
    <div class="topbar">
      <span class="material-icons-outlined" style="cursor:pointer" onclick="document.getElementById('sidebar').classList.toggle('collapsed')">menu</span>
      <h5 class="mb-0 text-primary">Training Institute Management</h5>
      <span class="badge bg-primary">Admin</span>
    </div>

    <div class="container-fluid">

      <!-- ========== DASHBOARD SECTION ========== -->
      <div id="dashboardSection">
        <h4 class="mb-4">System Overview</h4>
        <div class="row g-3">
          <div class="col-md-3">
            <div class="stat-card">
              <span class="material-icons-outlined">groups</span>
              <h5 id="studentCount">0</h5>
              <p class="text-muted">Students</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <span class="material-icons-outlined">badge</span>
              <h5 id="trainerCount">0</h5>
              <p class="text-muted">Trainers</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <span class="material-icons-outlined">class</span>
              <h5 id="courseCount">0</h5>
              <p class="text-muted">Courses</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <span class="material-icons-outlined">event_available</span>
              <h5 id="scheduleCount">0</h5>
              <p class="text-muted">Schedules</p>
            </div>
          </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card p-4">
              <h5>Quick Actions</h5>
              <div class="d-flex gap-2 flex-wrap mt-3">
                <button class="btn btn-primary" onclick="showSection('users'); document.querySelectorAll('.sidebar ul li')[1].click();">
                  <span class="material-icons-outlined align-middle">people</span> Manage Users
                </button>
                <button class="btn btn-success" onclick="showSection('courses'); document.querySelectorAll('.sidebar ul li')[2].click();">
                  <span class="material-icons-outlined align-middle">add</span> Add Course
                </button>
                <button class="btn btn-warning" onclick="showSection('enrollments'); document.querySelectorAll('.sidebar ul li')[3].click();">
                  <span class="material-icons-outlined align-middle">school</span> Enroll Students
                </button>
                <button class="btn btn-info text-white" onclick="showSection('schedules'); document.querySelectorAll('.sidebar ul li')[4].click();">
                  <span class="material-icons-outlined align-middle">calendar_month</span> Manage Schedule
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="usersSection" class="hidden">
        <h4 class="mb-3">User Management</h4>
        <div class="row">
          <div class="col-md-4">
            <div class="card p-3">
              <h6>üìÇ Bulk Upload Users</h6>
              <p class="text-muted small">Upload CSV (username, password, role)</p>
              <input type="file" id="csvFile" class="form-control mb-2" accept=".csv">
              <button class="btn btn-primary w-100" onclick="uploadCSV()">Upload CSV</button>
              <div id="uploadMsg" class="mt-2 text-center"></div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card p-3">
              <div class="d-flex justify-content-between mb-2">
                <h6>User List</h6>
                <div>
                  <select id="userRoleFilter" class="form-select form-select-sm d-inline-block w-auto me-2" onchange="filterUsers()">
                    <option value="ALL">All Users</option>
                    <option value="TRAINER">Trainers Only</option>
                    <option value="STUDENT">Students Only</option>
                  </select>
                  <button class="btn btn-sm btn-outline-primary" onclick="loadUsers()">Refresh</button>
                </div>
              </div>
              <div class="scroll-box">
                <table class="table table-sm table-hover">
                  <thead class="table-light">
                    <tr><th>ID</th><th>Username</th><th>Role</th></tr>
                  </thead>
                  <tbody id="userTableBody">
                    <tr><td colspan="3" class="text-center">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="coursesSection" class="hidden">
        <h4 class="mb-3">Course & Module Management</h4>
        <div class="row">
          <div class="col-md-4">
            <div class="card p-3 mb-3">
              <h6>üìò Add New Course</h6>
              <input type="text" id="newCourseName" class="form-control mb-2" placeholder="Course Name (e.g. Java)">
              <input type="text" id="newCourseDesc" class="form-control mb-2" placeholder="Description">
              <input type="text" id="newCourseDur" class="form-control mb-2" placeholder="Duration (e.g. 3 Months)">
              <button class="btn btn-success w-100" onclick="addCourse()">Create Course</button>
            </div>
            
            <div class="card p-3">
              <h6>üì¶ Add Module to Course</h6>
              <select id="modCourseSelect" class="form-select mb-2">
                <option value="">-- Select Course --</option>
              </select>
              <input type="text" id="modName" class="form-control mb-2" placeholder="Module Name">
              <button class="btn btn-secondary w-100" onclick="addModule()">Add Module</button>
            </div>
          </div>
          
          <div class="col-md-8">
            <div class="card p-3">
              <div class="d-flex justify-content-between mb-2">
                <h6>Courses with Modules</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="loadCoursesWithModules()">Refresh</button>
              </div>
              <div class="scroll-box" id="coursesContainer">
                <p class="text-muted text-center">Loading courses...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="enrollmentsSection" class="hidden">
        <h4 class="mb-3">Student Enrollment</h4>
        <div class="row">
          <div class="col-md-6">
            <div class="card p-4 border-start border-4 border-primary">
              <h5>üéì Single Enrollment</h5>
              <p class="text-muted small">Enroll one student in a course</p>
              <div class="mb-3">
                <label class="form-label">Select Student</label>
                <select id="enrollStudentSelect" class="form-select">
                  <option value="">-- Select Student --</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Select Course</label>
                <select id="enrollCourseSelect" class="form-select">
                  <option value="">-- Select Course --</option>
                </select>
              </div>
              <button class="btn btn-primary w-100" onclick="enrollStudent()">Enroll Student</button>
              <div id="enrollMsg" class="mt-2 text-center"></div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card p-4 border-start border-4 border-warning">
              <h5>üìö Bulk Enrollment</h5>
              <p class="text-muted small">Select multiple students and enroll in a course</p>
              <div class="mb-3">
                <label class="form-label">Select Course</label>
                <select id="bulkEnrollCourseSelect" class="form-select">
                  <option value="">-- Select Course --</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Select Students</label>
                <div class="border rounded p-2 scroll-box" style="max-height: 180px;">
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="selectAllStudents" onchange="toggleSelectAll()">
                    <label class="form-check-label fw-bold" for="selectAllStudents">Select All</label>
                  </div>
                  <hr class="my-2">
                  <div id="bulkStudentCheckboxes">
                    <p class="text-muted small">Loading students...</p>
                  </div>
                </div>
              </div>
              <button class="btn btn-warning w-100" onclick="bulkEnrollStudents()">
                <span class="material-icons-outlined align-middle" style="font-size:18px">group_add</span> 
                Enroll Selected Students
              </button>
              <div id="bulkEnrollMsg" class="mt-2 text-center"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="schedulesSection" class="hidden">
        <h4 class="mb-3">Schedule Management</h4>
        <div class="row">
          <div class="col-md-4">
            <div class="card p-3">
              <h6>üìÖ Create Weekly Schedule</h6>
              <p class="text-muted small">4 slots/day √ó 5 days = 20 slots</p>
              <label class="small text-muted">Select Start Date (Monday)</label>
              <input type="date" id="startDate" class="form-control mb-2">
              <button class="btn btn-primary w-100" onclick="createSchedule()">Generate Empty Slots</button>
              <div id="schedMsg" class="mt-2 text-center"></div>
              
              <!-- Time Slots Reference -->
              <div class="mt-3 p-2 bg-light rounded">
                <p class="small mb-1 fw-bold">Time Slots:</p>
                <ul class="small mb-0 ps-3">
                  <li>8:00 AM - 11:00 AM</li>
                  <li>11:00 AM - 2:00 PM</li>
                  <li>2:00 PM - 5:00 PM</li>
                  <li>5:00 PM - 8:00 PM</li>
                </ul>
              </div>
            </div>
          </div>

          <div class="col-md-8">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6>Manage Slots</h6>
                <div class="input-group w-auto">
                  <input type="number" id="viewWeekId" class="form-control form-control-sm" placeholder="Week ID" value="1" style="max-width: 100px;">
                  <button class="btn btn-sm btn-info text-white" onclick="loadSchedule()">Load Slots</button>
                </div>
              </div>
              
              <!-- Schedule Grid View -->
              <div class="mb-3">
                <div class="schedule-grid" id="scheduleGrid">
                  <div class="schedule-header">Time</div>
                  <div class="schedule-header">Monday</div>
                  <div class="schedule-header">Tuesday</div>
                  <div class="schedule-header">Wednesday</div>
                  <div class="schedule-header">Thursday</div>
                  <div class="schedule-header">Friday</div>
                </div>
              </div>
              <p class="text-muted small">üí° Click on a slot to assign trainer & module</p>
              
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="modal fade" id="assignSlotModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <span class="material-icons-outlined align-middle">edit_calendar</span> 
            Assign Slot
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="assignSlotId">
          <div class="mb-3">
            <label class="form-label">Slot Info</label>
            <input type="text" id="slotInfo" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Select Trainer</label>
            <select id="assignTrainerSelect" class="form-select">
              <option value="">-- Select Trainer --</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Select Module</label>
            <select id="assignModuleSelect" class="form-select">
              <option value="">-- Select Module --</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="confirmAssignSlot()">
            <span class="material-icons-outlined align-middle" style="font-size:18px">check</span> Assign
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ==================== CONFIG & AUTH ====================
    const GATEWAY_URL = "http://localhost:8090";
    const token = localStorage.getItem("jwt_token");

    // Check Auth
    if (!token) location.href = "login.html";
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      if (payload.role !== "ADMIN") throw new Error("Not Admin");
    } catch(e) {
      alert("Unauthorized: Admins only.");
      location.href = "login.html";
    }

    function logout() { localStorage.clear(); location.href = "login.html"; }

    // ==================== NAVIGATION ====================
    function showSection(id) {
      // Hide all sections
      ['dashboard','users','courses','enrollments','schedules'].forEach(sec => {
          const el = document.getElementById(sec + 'Section');
          if(el) el.classList.add('hidden');
      });
      
      // Show active section
      const activeEl = document.getElementById(id + 'Section');
      if(activeEl) activeEl.classList.remove('hidden');
      
      // Highlight Sidebar
      document.querySelectorAll('.sidebar ul li').forEach(li => li.classList.remove('active'));
      if(event && event.currentTarget) {
        event.currentTarget.classList.add('active');
      }
    }

    // ==================== API HELPER ====================
    async function apiFetch(endpoint, options = {}) {
      const res = await fetch(GATEWAY_URL + endpoint, {
        ...options,
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', ...(options.headers || {}) }
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => "Unknown Error");
        throw new Error(txt || res.statusText);
      }
      return res.status === 204 ? null : res.json();
    }

    // ==================== GLOBAL DATA STORAGE ====================
    let allUsers = [];
    let allCourses = [];
    let allModules = [];
    let currentScheduleSlots = [];

    // ==================== DASHBOARD ====================
    async function loadDashboardCounts() {
      try {
        const [users, courses] = await Promise.all([
          apiFetch("/api/users"),
          apiFetch("/api/courses")
        ]);
        allUsers = users;
        allCourses = courses;
        
        document.getElementById("studentCount").innerText = users.filter(u => u.role === "STUDENT").length;
        document.getElementById("trainerCount").innerText = users.filter(u => u.role === "TRAINER").length;
        document.getElementById("courseCount").innerText = courses.length;
      } catch(e) { console.error("Stats error", e); }
    }

    // ==================== USER FUNCTIONS ====================
    async function uploadCSV() {
      const file = document.getElementById("csvFile").files[0];
      if(!file) return alert("Please select a file");
      
      const fd = new FormData();
      fd.append("file", file);
      
      try {
        // Note: Do NOT set Content-Type header for FormData, browser does it
        await fetch(GATEWAY_URL + "/api/users/bulk-upload", {
          method: "POST", 
          headers: { 'Authorization': `Bearer ${token}` }, 
          body: fd
        });
        document.getElementById("uploadMsg").innerHTML = '<span class="text-success">‚úÖ Upload Successful!</span>';
        loadUsers();
        loadDashboardCounts();
      } catch(e) { 
        document.getElementById("uploadMsg").innerHTML = '<span class="text-danger">‚ùå Upload Failed</span>';
      }
    }

    async function loadUsers() {
      try {
        const users = await apiFetch("/api/users");
        allUsers = users;
        displayUsers(users);
      } catch(e) { 
        document.getElementById("userTableBody").innerHTML = `<tr><td colspan="3" class="text-danger">Failed to load</td></tr>`; 
      }
    }

    function displayUsers(users) {
      document.getElementById("userTableBody").innerHTML = users.map(u => 
        `<tr>
          <td>${u.id}</td>
          <td>${u.username}</td>
          <td><span class="badge bg-${u.role==='ADMIN'?'danger':u.role==='TRAINER'?'warning':'secondary'}">${u.role}</span></td>
        </tr>`
      ).join("") || '<tr><td colspan="3" class="text-muted">No users found</td></tr>';
    }

    function filterUsers() {
      const role = document.getElementById("userRoleFilter").value;
      if(role === "ALL") displayUsers(allUsers);
      else displayUsers(allUsers.filter(u => u.role === role));
    }

    // ==================== COURSE FUNCTIONS ====================
    async function loadCourses() {
      try {
        const courses = await apiFetch("/api/courses");
        allCourses = courses;
        return courses;
      } catch(e) { 
        console.error(e); 
        return [];
      }
    }

    async function loadCoursesWithModules() {
      try {
        const courses = await apiFetch("/api/courses");
        allCourses = courses;
        allModules = [];
        
        // Update course dropdown
        document.getElementById("modCourseSelect").innerHTML = 
          '<option value="">-- Select Course --</option>' +
          courses.map(c => `<option value="${c.id}">${c.courseName}</option>`).join('');
        
        let html = '';
        for(const course of courses) {
          let modules = [];
          try {
            modules = await apiFetch(`/api/courses/${course.id}/modules`);
            modules.forEach(m => {
              m.courseName = course.courseName;
              m.courseId = course.id;
              allModules.push(m);
            });
          } catch(e) { console.warn(`No modules for course ${course.id}`); }
          
          html += `
            <div class="card mb-2 p-3">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1"><span class="badge bg-primary me-2">${course.id}</span>${course.courseName}</h6>
                  <p class="text-muted small mb-1">${course.description || ''}</p>
                </div>
              </div>
              <div class="mt-2">
                <strong class="small">Modules:</strong>
                ${modules.length 
                  ? modules.map(m => `<span class="module-badge">${m.moduleName}</span>`).join('') 
                  : '<span class="text-muted small"> No modules yet</span>'
                }
              </div>
            </div>`;
        }
        document.getElementById("coursesContainer").innerHTML = html || '<p class="text-muted text-center">No courses found.</p>';
      } catch(e) { 
        document.getElementById("coursesContainer").innerHTML = '<p class="text-danger">Failed to load courses</p>';
      }
    }

    async function addCourse() {
      const payload = {
        courseName: document.getElementById("newCourseName").value,
        description: document.getElementById("newCourseDesc").value,
        duration: document.getElementById("newCourseDur").value
      };
      if(!payload.courseName) return alert("Course name is required");
      try {
        await apiFetch("/api/courses", { method: "POST", body: JSON.stringify(payload) });
        alert("‚úÖ Course Created!");
        loadCoursesWithModules();
      } catch(e) { alert("‚ùå Failed: " + e.message); }
    }

    async function addModule() {
      const cid = document.getElementById("modCourseSelect").value;
      const name = document.getElementById("modName").value;
      if(!cid || !name) return alert("Select course and enter name");
      try {
        await apiFetch(`/api/courses/${cid}/modules`, { method: "POST", body: JSON.stringify({moduleName: name}) });
        alert("‚úÖ Module Added!");
        loadCoursesWithModules();
      } catch(e) { alert("‚ùå Error: " + e.message); }
    }

    // ==================== ENROLLMENT FUNCTIONS ====================
    async function loadEnrollmentDropdowns() {
      try {
        if (allUsers.length === 0) allUsers = await apiFetch("/api/users");
        if (allCourses.length === 0) allCourses = await apiFetch("/api/courses");
        
        const students = allUsers.filter(u => u.role === "STUDENT");
        
        const studentOptions = students.map(s => `<option value="${s.id}">${s.username} (ID: ${s.id})</option>`).join('');
        const courseOptions = allCourses.map(c => `<option value="${c.id}">${c.courseName}</option>`).join('');
        
        document.getElementById("enrollStudentSelect").innerHTML = '<option value="">-- Select Student --</option>' + studentOptions;
        document.getElementById("enrollCourseSelect").innerHTML = '<option value="">-- Select Course --</option>' + courseOptions;
        document.getElementById("bulkEnrollCourseSelect").innerHTML = '<option value="">-- Select Course --</option>' + courseOptions;
        
        document.getElementById("bulkStudentCheckboxes").innerHTML = students.length
          ? students.map(s => `
              <div class="form-check">
                <input class="form-check-input student-checkbox" type="checkbox" value="${s.id}" id="student_${s.id}">
                <label class="form-check-label" for="student_${s.id}">${s.username}</label>
              </div>`).join('')
          : '<p class="text-muted small">No students available</p>';
      } catch(e) { console.error(e); }
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById("selectAllStudents").checked;
      document.querySelectorAll(".student-checkbox").forEach(cb => cb.checked = selectAll);
    }

    async function enrollStudent() {
      const sid = document.getElementById("enrollStudentSelect").value;
      const cid = document.getElementById("enrollCourseSelect").value;
      if(!sid || !cid) return;
      try {
        await apiFetch("/api/enrollments", { method: "POST", body: JSON.stringify({studentId: parseInt(sid), courseId: parseInt(cid)}) });
        document.getElementById("enrollMsg").innerHTML = '<span class="text-success fw-bold">‚úÖ Success!</span>';
      } catch(e) { document.getElementById("enrollMsg").innerHTML = `<span class="text-danger fw-bold">‚ùå ${e.message}</span>`; }
    }

    async function bulkEnrollStudents() {
      const courseId = document.getElementById("bulkEnrollCourseSelect").value;
      const ids = Array.from(document.querySelectorAll(".student-checkbox:checked")).map(cb => parseInt(cb.value));
      if(!courseId || ids.length === 0) return alert("Select course and students");
      try {
        await apiFetch("/api/enrollments/bulk", { method: "POST", body: JSON.stringify({ studentIds: ids, courseId: parseInt(courseId) }) });
        document.getElementById("bulkEnrollMsg").innerHTML = `<span class="text-success fw-bold">‚úÖ Enrolled ${ids.length} students!</span>`;
      } catch(e) { document.getElementById("bulkEnrollMsg").innerHTML = `<span class="text-danger fw-bold">‚ùå ${e.message}</span>`; }
    }

    // ==================== SCHEDULE FUNCTIONS (FIXED) ====================
    const TIME_SLOTS = [
      { label: "8 AM - 11 AM", start: "08:00", end: "11:00" },
      { label: "11 AM - 2 PM", start: "11:00", end: "14:00" },
      { label: "2 PM - 5 PM", start: "14:00", end: "17:00" },
      { label: "5 PM - 8 PM", start: "17:00", end: "20:00" }
    ];
    const DAYS = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY"];

    async function createSchedule() {
      const date = document.getElementById("startDate").value;
      if(!date) return alert("Select Date");
      try {
        const res = await apiFetch(`/api/schedule?startDate=${date}`, { method: "POST" });
        document.getElementById("schedMsg").innerHTML = `<span class="text-success">‚úÖ Created Week ID: ${res.id}</span>`;
        document.getElementById("viewWeekId").value = res.id;
        loadSchedule();
      } catch(e) { document.getElementById("schedMsg").innerHTML = `<span class="text-danger">‚ùå ${e.message}</span>`; }
    }

    async function loadSchedule() {
      const id = document.getElementById("viewWeekId").value;
      if(!id) return alert("Enter Week ID");
      
      try {
        // 1. Fetch Slots
        const data = await apiFetch(`/api/schedule/${id}`);
        
        // 2. Load Helpers (Users & Modules) to Map IDs to Names
        await loadTrainersAndModulesForAssign(); 
        
        // 3. Map the raw IDs to Names for Display
        currentScheduleSlots = (data.slots || []).map(slot => {
            const trainer = allUsers.find(u => u.id === slot.trainerId);
            const module = allModules.find(m => m.id === slot.moduleId);
            return {
                ...slot,
                trainerName: trainer ? trainer.username : (slot.trainerId ? `ID:${slot.trainerId}` : null),
                moduleName: module ? module.moduleName : (slot.moduleId ? `ID:${slot.moduleId}` : null)
            };
        });

        renderScheduleGrid();
        renderSlotsTable();
      } catch(e) { 
        console.error(e);
        document.getElementById("slotsTableBody").innerHTML = `<tr><td colspan="7" class="text-danger">Schedule Not Found</td></tr>`; 
        renderEmptyGrid();
      }
    }

    async function loadTrainersAndModulesForAssign() {
      try {
        if (allUsers.length === 0) allUsers = await apiFetch("/api/users");
        if (allCourses.length === 0) allCourses = await apiFetch("/api/courses");
        
        allModules = [];
        for(const course of allCourses) {
          try {
            const modules = await apiFetch(`/api/courses/${course.id}/modules`);
            if(modules) {
                modules.forEach(m => {
                  m.courseName = course.courseName;
                  m.courseId = course.id;
                  allModules.push(m);
                });
            }
          } catch(e) { console.warn(`Failed to fetch modules for course ${course.id}: ${e.message}`); }
        }
      } catch(e) { console.error("Error loading data for assignment", e); }
    }

    function renderScheduleGrid() {
      let html = `<div class="schedule-header">Time</div>` + DAYS.map(d => `<div class="schedule-header">${d}</div>`).join('');
      
      TIME_SLOTS.forEach((timeSlot) => {
        html += `<div class="schedule-cell time-slot">${timeSlot.label}</div>`;
        DAYS.forEach(day => {
          const slot = currentScheduleSlots.find(s => s.dayOfWeek === day && s.startTime.startsWith(timeSlot.start.substring(0,5)));
          
          if(slot) {
            if(slot.booked) {
              html += `
                <div class="schedule-cell slot-booked" onclick="openAssignModal(${slot.id}, '${day}', '${timeSlot.label}')">
                  <strong class="text-success small">üìö ${slot.moduleName}</strong><br>
                  <span class="text-muted small">üë§ ${slot.trainerName}</span>
                </div>`;
            } else {
              html += `<div class="schedule-cell slot-empty" onclick="openAssignModal(${slot.id}, '${day}', '${timeSlot.label}')"><span class="text-muted small">+ Assign</span></div>`;
            }
          } else {
            html += `<div class="schedule-cell slot-empty"><span class="text-muted small">-</span></div>`;
          }
        });
      });
      document.getElementById("scheduleGrid").innerHTML = html;
    }

    function renderEmptyGrid() {
      // Basic empty grid
      let html = `<div class="schedule-header">Time</div>` + DAYS.map(d => `<div class="schedule-header">${d}</div>`).join('');
      TIME_SLOTS.forEach(ts => {
        html += `<div class="schedule-cell time-slot">${ts.label}</div>`;
        DAYS.forEach(() => html += `<div class="schedule-cell slot-empty"><span class="text-muted small">-</span></div>`);
      });
      document.getElementById("scheduleGrid").innerHTML = html;
    }

    function renderSlotsTable() {
      document.getElementById("slotsTableBody").innerHTML = currentScheduleSlots.map(s => `
        <tr>
          <td>${s.id}</td>
          <td>${s.dayOfWeek}</td>
          <td>${s.startTime.substring(0,5)}</td>
          <td>${s.booked ? '<span class="badge bg-success">Booked</span>' : '<span class="badge bg-secondary">Empty</span>'}</td>
          <td>${s.trainerName || '-'}</td>
          <td>${s.moduleName || '-'}</td>
          <td><button class="btn btn-sm btn-primary" onclick="openAssignModal(${s.id}, '${s.dayOfWeek}')">Assign</button></td>
        </tr>`).join("") || '<tr><td colspan="7" class="text-muted">No slots</td></tr>';
    }

    function openAssignModal(slotId, day, time) {
      document.getElementById("assignSlotId").value = slotId;
      if(day) document.getElementById("slotInfo").value = `${day} | ${time || ''}`;
      
      // Populate dropdowns
      const trainers = allUsers.filter(u => u.role === "TRAINER");
      document.getElementById("assignTrainerSelect").innerHTML = '<option value="">-- Select Trainer --</option>' +
        trainers.map(t => `<option value="${t.id}">${t.username}</option>`).join('');
      
      document.getElementById("assignModuleSelect").innerHTML = '<option value="">-- Select Module --</option>' +
        allModules.map(m => `<option value="${m.id}">${m.moduleName} (${m.courseName})</option>`).join('');
      
      // Pre-select existing values
      const slot = currentScheduleSlots.find(s => s.id === slotId);
      if(slot && slot.trainerId) document.getElementById("assignTrainerSelect").value = slot.trainerId;
      if(slot && slot.moduleId) document.getElementById("assignModuleSelect").value = slot.moduleId;
      
      new bootstrap.Modal(document.getElementById('assignSlotModal')).show();
    }

    async function confirmAssignSlot() {
      const slotId = document.getElementById("assignSlotId").value;
      const trainerId = document.getElementById("assignTrainerSelect").value;
      const moduleId = document.getElementById("assignModuleSelect").value;
      
      if(!trainerId || !moduleId) return alert("Select both trainer and module");
      
      try {
        await apiFetch(`/api/schedule/slot/${slotId}`, {
          method: "PUT",
          body: JSON.stringify({ trainerId: parseInt(trainerId), moduleId: parseInt(moduleId) })
        });
        
        bootstrap.Modal.getInstance(document.getElementById('assignSlotModal')).hide();
        alert("‚úÖ Assigned Successfully!");
        loadSchedule();
      } catch(e) { alert("‚ùå " + e.message); }
    }

    // Init
    loadDashboardCounts();
    loadUsers();
    loadCourses().then(() => loadCoursesWithModules());

    // Navigation Listeners
    document.querySelectorAll('.sidebar ul li').forEach((li, index) => {
      li.addEventListener('click', function() {
        switch(index) {
          case 1: loadUsers(); break;
          case 2: loadCoursesWithModules(); break;
          case 3: loadEnrollmentDropdowns(); break;
          case 4: loadCourses().then(() => loadTrainersAndModulesForAssign()); break;
        }
      });
    });
</script>
</body>
</html>