<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f4f7f6; padding:20px; }
    .card { box-shadow:0 4px 8px rgba(0,0,0,.1); border:none; margin-bottom:20px; }
    .scroll-box { max-height:300px; overflow-y:auto; }
  </style>
</head>
<body>

<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>üõ†Ô∏è Admin Dashboard</h3>
    <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="card p-3">
        <h6>üìÇ Upload Users (CSV)</h6>
        <input type="file" id="csvFile" class="form-control mb-2" accept=".csv">
        <button class="btn btn-primary w-100" onclick="uploadCSV()">Upload</button>
        <div id="uploadResult" class="mt-2"></div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3">
        <h6>üìÖ Create Weekly Schedule</h6>
        <input type="date" id="startDate" class="form-control mb-2">
        <button class="btn btn-success w-100" onclick="createSchedule()">Create</button>
        <div id="scheduleResult" class="mt-2"></div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3">
        <h6>üéì Enroll Student</h6>
        <input type="number" id="enrollStudentId" class="form-control mb-2" placeholder="Student ID">
        <input type="number" id="enrollCourseId" class="form-control mb-2" placeholder="Course ID">
        <button class="btn btn-warning w-100" onclick="enrollStudent()">Enroll</button>
        <div id="enrollResult" class="mt-2"></div>
      </div>
    </div>
  </div>

<div class="col-md-4">
  <div class="card p-3">
    <h6>üìö Add New Course</h6>
    <input type="text" id="newCourseName" class="form-control mb-2" placeholder="Name (e.g., Java)">
    <input type="text" id="newCourseDesc" class="form-control mb-2" placeholder="Description">
    <input type="text" id="newCourseDur" class="form-control mb-2" placeholder="Duration (e.g., 6 Months)">
    <button class="btn btn-dark w-100" onclick="addCourse()">Add Course</button>
    <div id="courseResult" class="mt-2"></div>
  </div>
</div>

<div class="col-md-4">
  <div class="card p-3">
    <h6>üì¶ Add Module to Course</h6>
    <input type="number" id="modCourseId" class="form-control mb-2" placeholder="Course ID (e.g., 1)">
    <input type="text" id="modName" class="form-control mb-2" placeholder="Module Name (e.g., Spring)">
    <button class="btn btn-secondary w-100" onclick="addModule()">Add Module</button>
    <div id="moduleResult" class="mt-2"></div>
  </div>
</div>

  <hr>

  <div class="row">
    <div class="col-md-6">
      <div class="card p-3">
        <div class="d-flex justify-content-between">
          <h6>üë§ Users</h6>
          <button class="btn btn-sm btn-outline-primary" onclick="loadUsers()">Refresh</button>
        </div>
        <div class="scroll-box">
          <table class="table table-sm">
            <thead><tr><th>ID</th><th>Name</th><th>Role</th></tr></thead>
            <tbody id="userTableBody">
              <tr><td colspan="3" class="text-muted text-center">Click Refresh to load</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <div class="d-flex justify-content-between">
          <h6>üìò Courses</h6>
          <button class="btn btn-sm btn-outline-primary" onclick="loadCourses()">Refresh</button>
        </div>
        <div class="scroll-box">
          <table class="table table-sm">
            <thead><tr><th>ID</th><th>Name</th><th>Duration</th></tr></thead>
            <tbody id="courseTableBody">
              <tr><td colspan="3" class="text-muted text-center">Click Refresh to load</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="card p-3">
    <div class="d-flex justify-content-between mb-2">
      <h6>üìÖ Schedule Slots</h6>
      <div class="input-group w-auto">
        <input type="number" id="viewWeekId" class="form-control form-control-sm" placeholder="Week ID" value="1">
        <button class="btn btn-sm btn-info" onclick="loadSchedule()">Load</button>
      </div>
    </div>

    <div class="scroll-box" style="max-height:400px">
      <table class="table table-bordered table-sm text-center">
        <thead>
          <tr><th>ID</th><th>Day</th><th>Time</th><th>Status</th><th>Trainer</th><th>Module</th><th>Action</th></tr>
        </thead>
        <tbody id="slotsTableBody">
          <tr><td colspan="7" class="text-muted">Enter Week ID and Click Load</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const GATEWAY_URL = "http://localhost:8090";
const token = localStorage.getItem("jwt_token");
if (!token) location.href = "login.html";

function parseJwt(token)
{
  try{
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        
    }).join(''));
    return JSON.parse(jsonPayload);    
  }catch(e){
    return null
  }
  }
  const usePayload = parseJwt(token);
  if(usePayload.role !== 'admin'|| usePayload.roles !== 'admin'){ 
    alert("You are not an Admin");
    window.location.href = "student.html";
}
/* ================= HELPERS ================= */
function logout() {
  localStorage.clear();
  location.href = "login.html";
}

// Robust Fetch Wrapper
async function apiFetch(path, options = {}) {
  const res = await fetch(GATEWAY_URL + path, {
    ...options,
    headers: {
      'Authorization': `Bearer ${token}`,
      ...(options.headers || {})
    }
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || `Error ${res.status}`);
  }
  return res.status === 204 ? null : res.json();
}

/* ================= ACTIONS ================= */
async function uploadCSV() {
  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("Select CSV");
  
  const fd = new FormData();
  fd.append("file", file);

  try {
    const res = await fetch(GATEWAY_URL + "/api/users/bulk-upload", {
      method: "POST", headers: { Authorization: `Bearer ${token}` }, body: fd
    });
    document.getElementById("uploadResult").innerHTML = `<span class="text-success">${await res.text()}</span>`;
  } catch (e) {
    document.getElementById("uploadResult").innerHTML = `<span class="text-danger">Failed</span>`;
  }
}

async function createSchedule() {
  const date = document.getElementById("startDate").value;
  if(!date) return alert("Select Date");
  try {
    const data = await apiFetch(`/api/schedule?startDate=${date}`, { method: "POST" });
    document.getElementById("scheduleResult").innerHTML = `<span class="text-success">Created ID: ${data.id}</span>`;
  } catch(e) { alert("Failed to create schedule"); }
}

async function enrollStudent() {
  const s = document.getElementById("enrollStudentId").value;
  const c = document.getElementById("enrollCourseId").value;
  if (!s || !c) return alert("IDs required");
  
  try {
    await apiFetch("/api/enrollments", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ studentId:+s, courseId:+c })
    });
    document.getElementById("enrollResult").innerHTML = `<span class="text-success">Enrolled</span>`;
  } catch(e) { 
    document.getElementById("enrollResult").innerHTML = `<span class="text-danger">Failed</span>`; 
  }
}

// --- FIXED LOAD USERS ---
async function loadUsers() {
  const tbody = document.getElementById("userTableBody");
  tbody.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";
  try {
    const users = await apiFetch("/api/users");
    tbody.innerHTML = users.map(u => 
      `<tr><td>${u.id}</td><td>${u.username}</td><td>${u.role}</td></tr>`
    ).join("");
  } catch (e) {
    console.error(e);
    tbody.innerHTML = `<tr><td colspan='3' class="text-danger">Failed to load users.<br>Check if GET /api/users exists in backend.</td></tr>`;
  }
}

// --- FIXED LOAD COURSES ---
async function loadCourses() {
  const tbody = document.getElementById("courseTableBody");
  try {
    const courses = await apiFetch("/api/courses");
    tbody.innerHTML = courses.map(c => 
      `<tr><td>${c.id}</td><td>${c.courseName}</td><td>${c.duration}</td></tr>`
    ).join("");
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan='3' class="text-danger">Failed to load courses</td></tr>`;
  }
}

// --- FIXED LOAD SCHEDULE ---
async function loadSchedule() {
  const id = document.getElementById("viewWeekId").value;
  const tbody = document.getElementById("slotsTableBody");
  
  if(!id) return alert("Enter Week ID");
  tbody.innerHTML = "<tr><td colspan='7'>Loading...</td></tr>";

  try {
    const data = await apiFetch(`/api/schedule/${id}`);
    tbody.innerHTML = data.slots.map(s => 
      `<tr>
        <td>${s.id}</td>
        <td>${s.dayOfWeek}</td>
        <td>${s.startTime}</td>
        <td>${s.booked ? '<span class="badge bg-success">Booked</span>' : '<span class="badge bg-secondary">Empty</span>'}</td>
        <td>${s.trainerId || '-'}</td>
        <td>${s.moduleId || '-'}</td>
        <td><button class="btn btn-sm btn-primary" onclick="assign(${s.id})">Assign</button></td>
      </tr>`
    ).join("");
  } catch (e) {
    console.error(e);
    tbody.innerHTML = `<tr><td colspan='7' class="text-danger">Schedule ID ${id} not found. <br>Create a schedule first!</td></tr>`;
  }
}

async function addCourse() {
  const name = document.getElementById("newCourseName").value;
  const desc = document.getElementById("newCourseDesc").value;
  const dur = document.getElementById("newCourseDur").value;

  if (!name || !dur) return alert("Name and Duration required");

  const payload = {
    courseName: name,
    description: desc,
    duration: dur
  };

  try {
    const res = await fetch(GATEWAY_URL + "/api/courses", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}` 
      },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      document.getElementById("courseResult").innerHTML = `<span class="text-success">Course Added!</span>`;
      loadCourses(); // Refresh the table immediately
    } else {
      document.getElementById("courseResult").innerHTML = `<span class="text-danger">Failed</span>`;
    }
  } catch (e) {
    alert("Server Error: Check Course Service");
  }
}

async function addModule() {
  const cid = document.getElementById("modCourseId").value;
  const name = document.getElementById("modName").value;

  if (!cid || !name) return alert("Course ID and Name required");

  try {
    const res = await fetch(`${GATEWAY_URL}/api/courses/${cid}/modules`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}` 
      },
      body: JSON.stringify({ moduleName: name })
    });

    if (res.ok) {
      document.getElementById("moduleResult").innerHTML = `<span class="text-success">Module Added!</span>`;
    } else {
      document.getElementById("moduleResult").innerHTML = `<span class="text-danger">Failed (Check ID)</span>`;
    }
  } catch (e) {
    alert("Server Error");
  }
}

async function assign(slotId) {
  const t = prompt("Trainer ID");
  const m = prompt("Module ID");
  if (!t || !m) return;

  try {
    await apiFetch(`/api/schedule/slot/${slotId}`, {
      method:"PUT", headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ trainerId:+t, moduleId:+m })
    });
    alert("Assigned successfully!");
    loadSchedule(); // Refresh
  } catch (e) {
    alert("Assignment Failed");
  }
}

/* initial load */
loadCourses();
</script>

</body>
</html>