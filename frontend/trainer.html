<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trainer Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #fcfcfc; font-family: 'Segoe UI', sans-serif; }
        .header { background-color: #ff9800; color: white; padding: 20px; text-align: center; }
        .card { border-left: 5px solid #ff9800; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="header">
    <div class="d-flex justify-content-between container align-items-center">
        <h1>üë®‚Äçüè´ Trainer Dashboard</h1>
        <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
    </div>
    <p>Welcome, <span id="trainerName">Trainer</span> (ID: <span id="trainerIdDisplay">Loading...</span>)</p>
</div>

<div class="container mt-4">
    <div id="statusMsg" class="alert alert-light text-center" style="display:none"></div>

    <div class="row mb-3 justify-content-center">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text">Week ID</span>
                <input type="number" id="weekId" class="form-control" value="1">
                <button class="btn btn-outline-warning" onclick="fetchMyClasses()">Load Schedule</button>
            </div>
        </div>
    </div>

    <div class="row" id="schedule-container">
        <div class="col-12 text-center mt-5">
            <div class="spinner-border text-warning" role="status"></div>
            <p class="text-muted">Loading your profile...</p>
        </div>
    </div>
</div>

<script>
    const GATEWAY_URL = "http://localhost:8090";
    const token = localStorage.getItem("jwt_token");
    const username = localStorage.getItem("username"); // Get email saved during login

    let TRAINER_ID = null;

    // 1. Security Check
    if (!token || !username) window.location.href = "login.html";
    document.getElementById('trainerName').innerText = username;

    function logout() { 
        localStorage.clear(); 
        window.location.href = "login.html"; 
    }

    // 2. AUTOMATIC ID FETCH (The Optimization)
    async function init() {
        try {
            // Fetch list of all users to find MY id
            // (Note: In a real app, you would have an endpoint like /api/users/me)
            const response = await fetch(`${GATEWAY_URL}/api/users`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error("Could not fetch user details");

            const users = await response.json();
            
            // Find the user object that matches my logged-in email
            const myUser = users.find(u => u.username === username);

            if (myUser) {
                TRAINER_ID = myUser.id;
                document.getElementById('trainerIdDisplay').innerText = TRAINER_ID;
                // Once ID is found, automatically load schedule
                fetchMyClasses();
            } else {
                showError("User profile not found. Contact Admin.");
            }

        } catch (error) {
            console.error(error);
            showError("Failed to load profile. Ensure User Service is running.");
        }
    }

    // 3. Fetch Classes
    async function fetchMyClasses() {
        if(!TRAINER_ID) return; // Guard clause

        const weekId = document.getElementById('weekId').value;
        const container = document.getElementById('schedule-container');
        container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-warning"></div></div>';

        try {
            const response = await fetch(`${GATEWAY_URL}/api/schedule/${weekId}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error("Schedule not found");

            const data = await response.json();
            
            // Filter slots for THIS Trainer ID
            const mySlots = data.slots.filter(slot => slot.trainerId == TRAINER_ID);
            renderSlots(mySlots);

        } catch (error) {
            container.innerHTML = `<div class="col-12 text-center text-muted">No schedule data found for Week ${weekId} (or API is down).</div>`;
        }
    }

    function renderSlots(slots) {
        const container = document.getElementById('schedule-container');
        container.innerHTML = "";

        if (slots.length === 0) {
            container.innerHTML = `<div class="col-12 alert alert-info text-center">You have no classes assigned for Week ${document.getElementById('weekId').value}.</div>`;
            return;
        }

        const days = { "MONDAY": 1, "TUESDAY": 2, "WEDNESDAY": 3, "THURSDAY": 4, "FRIDAY": 5, "SATURDAY": 6, "SUNDAY": 7 };
        slots.sort((a, b) => days[a.dayOfWeek] - days[b.dayOfWeek] || a.startTime.localeCompare(b.startTime));

        slots.forEach(slot => {
            const card = `
                <div class="col-md-4">
                    <div class="card p-3 mb-3">
                        <h5 class="text-warning">${slot.dayOfWeek}</h5>
                        <h6 class="text-muted">‚è∞ ${slot.startTime} - ${slot.endTime}</h6>
                        <hr>
                        <p class="mb-0"><strong>Module ID:</strong> ${slot.moduleId}</p>
                        <span class="badge bg-success mt-2">Assigned to You</span>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });
    }

    function showError(msg) {
        const el = document.getElementById('statusMsg');
        el.style.display = 'block';
        el.className = 'alert alert-danger text-center';
        el.innerText = msg;
        document.getElementById('schedule-container').innerHTML = "";
    }
    
    // Start the process
    init();
</script>

</body>
</html>