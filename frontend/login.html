<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Login - Training Institute</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
    body {
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: 'Segoe UI', sans-serif;
    }
    .login-card {
        background: #fff;
        padding: 40px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        width: 100%;
        max-width: 400px;
        position: relative;
    }
    .login-card h3 { text-align: center; margin-bottom: 30px; font-weight: 600; color: #333; }
    .form-floating { margin-bottom: 20px; position: relative; }
    .form-floating .form-control { border-radius: 10px; padding-left: 3rem; }
    .form-floating > label { padding-left: 3rem; }
    .form-floating i {
        position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
        color: #6c5ce7; font-size: 1.2rem; z-index: 5; pointer-events: none;
    }
    .btn-primary {
        width: 100%; background: #6c5ce7; border: none; border-radius: 10px;
        padding: 10px; font-weight: 500; transition: 0.3s;
    }
    .btn-primary:hover { background: #341f97; }
    .btn-primary:disabled { background: #a29bfe; cursor: not-allowed; }
    .text-center a { color: #6c5ce7; text-decoration: none; font-weight: 500; }
    .text-center a:hover { text-decoration: underline; }
    .spinner-border { width: 1rem; height: 1rem; margin-right: 8px; }
</style>
</head>
<body>

<div class="login-card">
    <h3>üîê User Login</h3>

    <form onsubmit="login(event)">
        <div class="form-floating">
            <input type="text" id="username" class="form-control" placeholder="Username" required>
            <label for="username">Username</label>
            <i class="bi bi-person-fill"></i>
        </div>

        <div class="form-floating">
            <input type="password" id="password" class="form-control" placeholder="Password" required>
            <label for="password">Password</label>
            <i class="bi bi-lock-fill"></i>
        </div>

        <button type="submit" class="btn btn-primary" id="loginBtn">
            <span id="btnText">Sign In</span>
            <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
        </button>
    </form>
    
    <div id="error-msg" class="mt-3 text-center"></div>

    <div class="text-center mt-3">
        <p>New User? <a href="register.html">Create an Account</a></p>
        <a href="#" onclick="forgotPassword()" class="text-muted small">Forgot Password?</a>
    </div>
</div>

<script>
const GATEWAY_URL = "http://localhost:8090";

function parseJwt(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    } catch (e) { return null; }
}

async function login(event) {
    if(event) event.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const errorDiv = document.getElementById('error-msg');
    const loginBtn = document.getElementById('loginBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    
    errorDiv.className = "mt-3 text-center";
    errorDiv.innerText = "";

    if (!username || !password) {
        errorDiv.className = "mt-3 text-danger text-center";
        errorDiv.innerText = "Please enter username and password.";
        return;
    }

    loginBtn.disabled = true;
    btnText.innerText = "Signing In...";
    btnSpinner.classList.remove('d-none');

    try {
        const response = await fetch(`${GATEWAY_URL}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        if (response.ok) {
            const token = await response.text();
            localStorage.setItem("jwt_token", token);
            localStorage.setItem("username", username);

            const payload = parseJwt(token);
            
            // FIXED: Ensure we capture the userId provided by the backend update
            if(payload && payload.userId) {
                localStorage.setItem("user_id", payload.userId);
            }
            if(payload && payload.role) {
                localStorage.setItem("user_role", payload.role);
            }
            
            errorDiv.className = "mt-3 text-success text-center";
            errorDiv.innerText = "‚úÖ Success! Redirecting...";

            setTimeout(() => {
                if (payload && payload.role === "ADMIN") {
                    window.location.href = "admin.html";
                } else if (payload && payload.role === "TRAINER") {
                    window.location.href = "trainer.html";
                } else if (payload && payload.role === "STUDENT") {
                    window.location.href = "student.html";
                } else {
                    // Fallback routing
                    if (username.toLowerCase().includes("admin")) window.location.href = "admin.html";
                    else if (username.toLowerCase().includes("trainer")) window.location.href = "trainer.html";
                    else window.location.href = "student.html";
                }
            }, 800);
        } else {
            const errorText = await response.text();
            errorDiv.className = "mt-3 text-danger text-center";
            errorDiv.innerText = "Invalid Credentials";
            resetBtn();
        }
    } catch (error) {
        console.error(error);
        errorDiv.className = "mt-3 text-danger text-center";
        errorDiv.innerText = "Server Error. Is API Gateway running?";
        resetBtn();
    }
    
    function resetBtn() {
        loginBtn.disabled = false;
        btnText.innerText = "Sign In";
        btnSpinner.classList.add('d-none');
    }
}

function forgotPassword() {
    const username = document.getElementById('username').value.trim();
    if(!username) {
        alert("Please enter your username in the field above first.");
        return;
    }
    
    // FIXED: Changed to use URL search params to match Backend @RequestParam
    fetch(`${GATEWAY_URL}/api/auth/forgot-password?username=${encodeURIComponent(username)}`, {
        method: 'POST'
    })
    .then(async res => {
        if(res.ok) {
            alert("‚úÖ Password reset instructions sent!");
        } else {
            alert("‚ùå User not found");
        }
    })
    .catch(() => alert("‚ùå Server error"));
}

// Redirect if already logged in
window.onload = function() {
    const token = localStorage.getItem("jwt_token");
    if(token) {
        const payload = parseJwt(token);
        const now = Math.floor(Date.now() / 1000);
        if(payload && payload.exp > now) {
            if(payload.role === "ADMIN") window.location.href = "admin.html";
            else if(payload.role === "TRAINER") window.location.href = "trainer.html";
            else window.location.href = "student.html";
        } else {
            localStorage.clear();
        }
    }
};

document.getElementById('password').addEventListener('keypress', function(e) {
    if(e.key === 'Enter') login(e);
});
</script>
</body>
</html>